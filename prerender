server {
    listen 80;
    listen [::]:80;
    # For https
    # listen 443 ssl;
    # listen [::]:443 ssl ipv6only=on;
    # ssl_certificate /var/certs/kdan.ksoj.club-cert1.pem;
    # ssl_certificate_key /var/certs/kdan.ksoj.club-privkey1.pem;
    server_name 127.0.0.1;
    root /var/www/hell/miatest/public;
    index index.html index.htm;
    location ~ ^/api {
        rewrite ^ /index.php;
    }
    location / {
          try_files $uri @prerender;
       #  try_files $uri $uri/ /index.html @prerender;
#         try_files $uri $uri/ /index.html /index.php;
    }
    location ~ ^/storage {
    	root /var/www/hell/miatest/public;
        try_files $uri $uri/;
#        add_header Access-Control-Allow-Origin http://oo24-erp.ksoj.club;
#        add_header Access-Control-Allow-Origin https://oo24-erp.ksoj.club;
        add_header Access-Control-Allow-Origin *;
    }
    location ~ \.php$ {
    	root /var/www/hell/miatest/public;
        try_files $uri /index.php =404;
        fastcgi_pass php-upstream;
        fastcgi_index index.php;
        fastcgi_buffers 16 16k;
        fastcgi_buffer_size 32k;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        #fixes timeouts
        fastcgi_read_timeout 600;
        include fastcgi_params;
    }
    location ~ /\.ht {
        deny all;
    }
    location /.well-known/acme-challenge/ {
        root /var/www/letsencrypt/;
        log_not_found off;
    }
    location @prerender {
        proxy_set_header X-Prerender-Token BHF34IZysfwTJo8BrFSY;
        set $prerender 0;
        if ($http_user_agent ~* "googlebot|bingbot|yandex|baiduspider|twitterbot|facebookexternalhit|rogerbot|linkedinbot|embedly|quora link preview|showyoubot|outbrain|pinterest\/0\.|pinterestbot|slackbot|vkShare|W3C_Validator|whatsapp") {
            set $prerender 1;
        }
        if ($args ~ "_escaped_fragment_") {
            set $prerender 1;
        }
        if ($http_user_agent ~ "Prerender") {
            set $prerender 0;
        }
        if ($uri ~* "\.(js|css|xml|less|png|jpg|jpeg|gif|pdf|doc|txt|ico|rss|zip|mp3|rar|exe|wmv|doc|avi|ppt|mpg|mpeg|tif|wav|mov|psd|ai|xls|mp4|m4a|swf|dat|dmg|iso|flv|m4v|torrent|ttf|woff|svg|eot)") {
            set $prerender 0;
        }
        
        #resolve using Google's DNS server to force DNS resolution and prevent caching of IPs
        resolver 8.8.8.8;
 
        if ($prerender = 1) {
            
            #setting prerender as a variable forces DNS resolution since nginx caches IPs and doesnt play well with load balancing
            set $prerender "service.prerender.io";
            rewrite .* /$scheme://$host$request_uri? break;
            proxy_pass http://$prerender;
        }
        if ($prerender = 0) {
            rewrite .* /index.html break;
        }
    }
    error_log /var/log/nginx/app_error.log;
    access_log /var/log/nginx/app_access.log;
}
